# Generate an argo app for each stage
{{ range $stage := .Values.stages }}
# Only output an app for this stage if the stage is enabled
{{- if or (not (hasKey $stage "enabled")) $stage.enabled }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  # App name is suffixed by the stage name
  name: {{ $.Release.Name }}-{{ $stage.name }}
  # Place the stage apps in the root namespace for the project
  namespace: {{ $.Release.Namespace }}

  finalizers:
    - resources-finalizer.argocd.argoproj.io

  annotations:
    # Give the stage within the kargo project permission to call argocd-update
    # on the app that is generated by this appset for the given stage
    kargo.akuity.io/authorized-stage: {{ $.Release.Name }}:{{ $stage.name }}
    kargo-pipelines.ukserp.ac.uk/component: argo-app
    {{- with $.Values.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- with $.Values.argocd.app.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}

  labels:
    component: argo-app
    app: {{ $.Chart.Name }}
    release: {{ $.Release.Name }}
    chart: {{ printf "%s-%s" $.Chart.Name $.Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
    heritage: {{ $.Release.Service }}
    {{- with $.Values.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- with $.Values.argocd.app.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  # Place the stage apps into the argocd project for the root app
  project: {{ $.Release.Name }}
  source:
    # Deploy every manifest found on the deployment branch for this stage
    # where the branch will be otherwise empty compared to main
    repoURL: {{ $.Values.warehouse.valuesFreight.repoURL }}
    targetRevision: deployment/{{ $.Release.Name }}-{{ $stage.name }}
    path: .
  destination:
    server: https://kubernetes.default.svc
    # Deploy everything for this stage into its own isolated namespace
    namespace: {{ $.Release.Namespace }}-{{ $stage.name }}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
{{- end }}
{{ end }}